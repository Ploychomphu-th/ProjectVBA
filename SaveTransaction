Sub btnSave_Click()
    Dim wsRental As Worksheet, wsTransaction As Worksheet, wsBook As Worksheet
    Dim tblOrder As ListObject, tblHistory As ListObject, tblBook As ListObject
    Dim newRow As ListRow
    Dim lastTransactionID As String, newTransactionID As String
    Dim r As ListRow
    Dim bookRow As ListRow
    Dim bookID As String
    Dim rentalQty As Integer
    Dim i As Long
    
    ' Define worksheets and tables
    Set wsRental = ThisWorkbook.Sheets("Rental")
    Set wsTransaction = ThisWorkbook.Sheets("Transaction")
    Set wsBook = ThisWorkbook.Sheets("Stock")
    
    Set tblOrder = wsRental.ListObjects("Order")
    Set tblHistory = wsTransaction.ListObjects("History")
    Set tblBook = wsBook.ListObjects("Book")
    
    ' Find the latest TransactionID and create a new ID
    If tblHistory.ListRows.Count > 0 Then
        lastTransactionID = tblHistory.ListRows(tblHistory.ListRows.Count).Range.Cells(1, 1).Value
        newTransactionID = "TS" & Format(Right(lastTransactionID, 3) + 1, "000")
    Else
        newTransactionID = "TS001"
    End If
    
    ' Loop through each row in Table: Order
    For Each r In tblOrder.ListRows
        ' Add a new row to Table: History
        Set newRow = tblHistory.ListRows.Add
        With newRow.Range
            .Cells(1, 1).Value = newTransactionID ' TransactionID
            .Cells(1, 2).Value = r.Range.Cells(1, 1).Value ' #No
            .Cells(1, 3).Value = r.Range.Cells(1, 2).Value ' MemberID
            .Cells(1, 4).Value = r.Range.Cells(1, 3).Value ' BookID
            .Cells(1, 5).Value = r.Range.Cells(1, 4).Value ' Title
            .Cells(1, 6).Value = r.Range.Cells(1, 5).Value ' RentalDate
            .Cells(1, 7).Value = r.Range.Cells(1, 6).Value ' DueDate
            .Cells(1, 8).Value = r.Range.Cells(1, 7).Value ' RentalPrice
            .Cells(1, 9).Value = r.Range.Cells(1, 8).Value ' Quantity
            .Cells(1, 10).Value = r.Range.Cells(1, 9).Value ' TotalPrice
            .Cells(1, 11).Value = "Rented" ' Add "Rented" to Status column
        End With
        
        ' Reduce stock in Table: Book
        bookID = r.Range.Cells(1, 3).Value ' Book ID
        rentalQty = r.Range.Cells(1, 8).Value ' Rented quantity
        
        For Each bookRow In tblBook.ListRows
            If bookRow.Range.Cells(1, 1).Value = bookID Then ' Find matching BookID
                bookRow.Range.Cells(1, 7).Value = bookRow.Range.Cells(1, 7).Value - rentalQty ' Deduct stock
                Exit For
            End If
        Next bookRow
    Next r
    
    ' Clear data in Table: Order after saving
    On Error Resume Next
    For i = tblOrder.ListRows.Count To 1 Step -1
        tblOrder.ListRows(i).Delete
    Next i
    On Error GoTo 0
    
    MsgBox "Data has been successfully saved to History and stock updated!", vbInformation
End Sub
